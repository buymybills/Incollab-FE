map $http_user_agent $is_mobile {
    default 0;
    ~*(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge\ |maemo|midp|mmp|mobile.+firefox|netfront|opera\ m(ob|in)i|palm(\ os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows\ ce|xda|xiino|android|ipad|playbook|silk 1;
}

map $uri $is_allowed_page {
    default 0;
    ~^/terms 1;
    ~^/privacy-policy 1;
}

# Allow requests coming from the official mobile app (identified via header)
map $http_x_collabkaroo_app $is_app_request {
    default 0;
    ~*collabkaroo-app-v1 1;
}

# Persist allowlist across redirects using a cookie set on first request
map $http_cookie $is_app_cookie {
    default 0;
    ~*ck_collabkaroo_app=1 1;
}

server {
    listen 80;
    server_name collabkaroo.buymybills.in collabkaroo.com www.collabkaroo.com;  # Main domains

    # Redirect all HTTP traffic to HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name collabkaroo.buymybills.in collabkaroo.com www.collabkaroo.com;  # Main domains

    # SSL configuration will be added by Certbot automatically
    # Debug/trace header to verify this vhost is serving the request
    add_header X-Incollab-Vhost "main-collabkaroo" always;
    
    # Access control based on device type, allowed pages, and app header/cookie
    # Block only when: not mobile AND not an allowed page AND not from app (header or cookie)
    set $block_desktop 0;
    if ($is_mobile = 0) { set $block_desktop 1; }
    if ($is_allowed_page = 1) { set $block_desktop 0; }
    if ($is_app_request = 1) { set $block_desktop 0; }
    if ($is_app_cookie = 1) { set $block_desktop 0; }
    if ($block_desktop = 1) { return 403; }

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # Next.js static files
    location /_next/static/ {
        proxy_cache STATIC;
        proxy_pass http://localhost:3000;
        proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
        proxy_cache_valid 60m;
        proxy_cache_bypass $http_cache_control;
        add_header X-Cache-Status $upstream_cache_status;
    }

    # Main application proxy
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Collabkaroo-App $http_x_collabkaroo_app;
        proxy_cache_bypass $http_upgrade;
        
        # When app header is present, set a cookie so subsequent redirects work without the header
        if ($is_app_request = 1) {
            add_header Set-Cookie "ck_collabkaroo_app=1; Path=/; Secure; HttpOnly; SameSite=Lax" always;
        }
    }

    # Specific routes that are allowed on desktop
    location ~ ^/(terms|privacy-policy) {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Collabkaroo-App $http_x_collabkaroo_app;
        proxy_cache_bypass $http_upgrade;
        add_header 'Access-Control-Allow-Origin' '*';
        if ($is_app_request = 1) {
            add_header Set-Cookie "ck_collabkaroo_app=1; Path=/; Secure; HttpOnly; SameSite=Lax" always;
        }
    }

    # Custom error page for mobile restriction
    error_page 403 /403.html;
    location = /403.html {
        internal;
        add_header X-Incollab-Vhost "main-collabkaroo" always;
        return 403 '<!DOCTYPE html>
        <html>
        <head>
            <title>Mobile App Only</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                .container { max-width: 600px; margin: 0 auto; text-align: center; }
                .button { display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; margin-top: 20px; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>Mobile App Only</h1>
                <p>This application is designed for mobile devices only. Please access it through our mobile app or visit from a mobile device.</p>
                <p>You can still access our:</p>
                <p><a href="/terms">Terms and Conditions</a> | <a href="/privacy-policy">Privacy Policy</a></p>
                <a href="[APP_STORE_LINK]" class="button">Download our App</a>
            </div>
        </body>
        </html>';
    }
}